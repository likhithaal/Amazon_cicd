
pipeline{
	agent any

    parameters {
		string(name: 'APP_VERSION', defaultValue: '1.0.0', description: 'Application Version')
        choice(name: 'ENV', choices: ['dev', 'qa', 'prod'], description: 'Select Environment')
		string(name: 'TOMCAT_USER', defaultValue: 'tomcatuser1', description: 'Tomcat Manager Username')
        string(name: 'TOMCAT_PASSWORD', defaultValue: 'tomcatuser1', description: 'Tomcat Manager Password')
		// password(name: 'TOMCAT_PASSWORD', defaultValue: 'tomcatuser1', description: 'Tomcat Manager Password')
    }

	environment {
        BRANCH_NAME = "${params.ENV}-branch"
		WAR_BACKUP_DIR = "/home/likhitha/Devops-course/jenkins/jenkins_backup"
		DEPLOY_SERVER = "localhost"  // Your Tomcat server IP
        DEPLOY_PATH = "/opt/tomcat/webapps"
        TOMCAT_MANAGER_URL = "http://localhost:8081/manager/Amazon"
    }
	
	stages{
    
		stage( 'Clone' ){
		steps{
			echo "Cloning branch: ${BRANCH_NAME}"
			git branch: "${BRANCH_NAME}" , url:'https://github.com/likhithaal/Amazon_cicd.git'
		    }
  		}
      
		stage( 'Clean' ){
		steps{
			sh 'cd Amazon && mvn clean'
			}
		}
		
		stage( 'Unit test' ){
		steps{
			sh 'cd Amazon && mvn test'
			}
		}
		
		stage( 'Building WAR' ){
		steps{
			echo "Building version: ${params.APP_VERSION}"
			sh "cd Amazon && mvn clean install -Dapp.version=${params.APP_VERSION}"
			}
		}
		
		stage('Backup WAR') {
        steps {
			sh "mkdir -p ${WAR_BACKUP_DIR}"
			sh "cp Amazon/Amazon-Web/target/*.war ${WAR_BACKUP_DIR}/amazon_${BUILD_NUMBER}.war"
            }
        }

		stage('Deploy to Tomcat') {
		steps {
			script {
				def warFile = findFiles(glob: 'Amazon/Amazon-Web/target/*.war')[0]
                    
				echo "Deploying ${warFile.name} to Tomcat"
                    
                    // Using Tomcat Manager API
				sh """
					curl -u ${params.TOMCAT_USER}:${params.TOMCAT_PASSWORD} \
						-T ${warFile.path} \
						${env.TOMCAT_MANAGER_URL}/deploy?path=/amazon&update=true
				"""
                }
            }
        }
		
	}
	
	post {
	success {
		echo "Pipeline completed successfully for ${env.BRANCH_NAME}"
	}
	failure {
		echo "Pipeline FAILED on ${env.BRANCH_NAME}"
	}
	}
}
