
pipeline{
	agent any

    parameters {
		string(name: 'APP_VERSION', defaultValue: '1.0.0', description: 'Application Version')
        choice(name: 'ENV', choices: ['dev', 'qa', 'prod'], description: 'Select Environment')
		string(name: 'TOMCAT_USER', defaultValue: 'tomcatuser1', description: 'Tomcat Manager Username')
        string(name: 'TOMCAT_PASSWORD', defaultValue: 'tomcatuser1', description: 'Tomcat Manager Password')
		// password(name: 'TOMCAT_PASSWORD', defaultValue: 'tomcatuser1', description: 'Tomcat Manager Password')
    }

	environment {
        BRANCH_NAME = "${params.ENV}-branch"
		WAR_BACKUP_DIR = "/home/likhitha/Devops-course/jenkins/jenkins_backup"
		DEPLOY_SERVER = "192.168.171.128" 
		TOMCAT_PORT = "8081"
		TOMCAT_MANAGER_URL = "http://${DEPLOY_SERVER}:${TOMCAT_PORT}/manager"  
		APP_URL = "http://${DEPLOY_SERVER}:${TOMCAT_PORT}/Amazon"
        // DEPLOY_PATH = "/opt/tomcat/webapps"
        // TOMCAT_MANAGER_URL = "http://localhost:8081/manager/text"
		// TOMCAT_MANAGER_URL = "http://localhost:8081/manager/text/deploy?path=/Amazon"
		
    }
	
	stages{
    
		stage( 'Clone' ){
		steps{
			echo "Cloning branch: ${BRANCH_NAME}"
			git branch: "${BRANCH_NAME}" , url:'https://github.com/likhithaal/Amazon_cicd.git'
		    }
  		}
      
		stage( 'Clean' ){
		steps{
			sh 'cd Amazon && mvn clean'
			}
		}
		
		stage( 'Unit test' ){
		steps{
			sh 'cd Amazon && mvn test'
			}
		}
		
		stage( 'Building WAR' ){
		steps{
			echo "Building version: ${params.APP_VERSION}"
			sh "cd Amazon && mvn clean install -Dapp.version=${params.APP_VERSION}"
			}
		}
		
		stage('Backup WAR') {
        steps {
			sh "mkdir -p ${WAR_BACKUP_DIR}"
			sh "cp Amazon/Amazon-Web/target/*.war ${WAR_BACKUP_DIR}/amazon_${BUILD_NUMBER}.war"
            }
        }

		        
        stage('Find WAR File') {
            steps {
                script {
                    sh """
                        echo "Looking for WAR files..."
                        find . -name "*.war" -type f
                        ls -la Amazon/Amazon-Web/target/*.war 2>/dev/null || echo "No WAR files found yet"
                    """
                }
            }
        }

/*		stage('Deploy to Tomcat') {
		steps {
			script {
				def warFile = findFiles(glob: 'Amazon/Amazon-Web/target/*.war')[0]
                    
				echo "Deploying ${warFile.name} to Tomcat"
                    
                    // Using Tomcat Manager API
				sh """
					curl -u ${params.TOMCAT_USER}:${params.TOMCAT_PASSWORD} \
						-T ${warFile.path} \
						${env.TOMCAT_MANAGER_URL}/deploy?path=/amazon&update=true
				"""
                }
            }
        }
		*/
	        stage('Deploy to Tomcat') {
            steps {
                script {
                    echo "Deploying to Tomcat Manager: ${env.TOMCAT_MANAGER_URL}"
                    echo "Using username: ${params.TOMCAT_USER}"
                    
                    // Method 1: Simple way (if only one WAR file)
                    sh """
                        echo "=== Starting Deployment ==="
                        
                        # Find the WAR file
                        WAR_FILE=\$(find Amazon/Amazon-Web/target -name "*.war" | head -1)
                        
                        if [ -z "\$WAR_FILE" ]; then
                            echo "ERROR: No WAR file found!"
                            exit 1
                        fi
                        
                        echo "Found WAR file: \$WAR_FILE"
                        
                        # Test Tomcat Manager connection first
                        echo "Testing Tomcat Manager connection..."
                        curl -u ${params.TOMCAT_USER}:${params.TOMCAT_PASSWORD} \
                             ${env.TOMCAT_MANAGER_URL}/list 2>/dev/null || echo "Connection test failed"
                        
                        # Deploy using Tomcat Manager
                        echo "Deploying to /Amazon context..."
                        curl -v -u ${params.TOMCAT_USER}:${params.TOMCAT_PASSWORD} \
                             -T "\$WAR_FILE" \
                             "${env.TOMCAT_MANAGER_URL}/deploy?path=/Amazon&update=true"
                        
                        echo "=== Deployment command executed ==="
                    """
                    
                    // Wait for deployment
                    sleep 15
                    
                    // Verify deployment
                    sh """
                        echo "Verifying application at: ${env.APP_URL}"
                        curl -f -s -o /dev/null -w "HTTP Status: %{http_code}\\n" ${env.APP_URL}/ \
                            && echo "âœ“ Deployment successful!" \
                            || echo " Application not responding yet"
                    """
                }
            }
        }
		
	}
	
	post {
	success {
		echo "Pipeline completed successfully for ${env.BRANCH_NAME}"
	}
	failure {
		echo "Pipeline FAILED on ${env.BRANCH_NAME}"
	}
	}
}
