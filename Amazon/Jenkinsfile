
pipeline{
	agent any

    parameters {
		string(name: 'APP_VERSION', defaultValue: '1.0.0', description: 'Application Version')
        choice(name: 'ENV', choices: ['dev', 'qa', 'prod'], description: 'Select Environment')
    }

	environment {
        BRANCH_NAME = "${params.ENV}-branch"
		WAR_BACKUP_DIR = "/home/likhitha/Devops-course/jenkins/jenkins_backup"
    }
	
	stages{
    
		stage( 'Clone' ){
		steps{
			echo "Cloning branch: ${BRANCH_NAME}"
			git branch: "${BRANCH_NAME}" , url:'https://github.com/likhithaal/Amazon_cicd.git'
		    }
  		}
      
		stage( 'Clean' ){
		steps{
			sh 'cd Amazon && mvn clean'
			}
		}
		
		stage( 'Unit test' ){
		steps{
			sh 'cd Amazon && mvn test'
			}
		}
		
		stage( 'Building WAR' ){
		steps{
			echo "Building version: ${params.APP_VERSION}"
			sh "cd Amazon && mvn clean install -Dapp.version=${params.APP_VERSION}"
			}
		}
		
		stage('Backup WAR') {
        steps {
			sh "mkdir -p ${WAR_BACKUP_DIR}"
			sh "cp Amazon/Amazon-Web/target/*.war ${WAR_BACKUP_DIR}/amazon_${BUILD_NUMBER}.war"
            }
        }
		
	}
	
	post {
	success {
		echo "Pipeline completed successfully for ${env.BRANCH_NAME}"
	}
	failure {
		echo "Pipeline FAILED on ${env.BRANCH_NAME}"
	}
	}
}
